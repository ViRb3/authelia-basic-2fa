auth_request /auth;
# allow auth cookies to reach client
auth_request_set $saved_set_cookie $upstream_http_set_cookie;
add_header Set-Cookie $saved_set_cookie;

# If Authelia returns 401, then nginx redirects the user to the login portal.
set $target_url $scheme://$http_host$request_uri;
error_page 401 =302 https://auth.website.com/?rd=$target_url;

# Set the X-Forwarded-User and X-Forwarded-Groups with the headers
# returned by Authelia for the backends which can consume them.
# This is not safe, as the backend must make sure that they come from the
# proxy. In the future, it's gonna be safe to just use OAuth.
auth_request_set $user $upstream_http_remote_user;
auth_request_set $groups $upstream_http_remote_groups;
proxy_set_header X-Forwarded-User $user;
proxy_set_header X-Forwarded-Groups $groups;

# use = to take precedence over other ~ locations
location = /auth {
    internal;

    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    include authelia-proxy.conf;

    proxy_pass http://authelia-basic-2fa:8081;
}